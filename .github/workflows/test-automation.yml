name: Test Automation Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Daily midnight run
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ 17 ]
        environment: [ qa, staging ]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
        cache: maven

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable

    - name: Run Tests
      env:
        DISPLAY: :99
        TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
        TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        mvn clean test \
        -Dtest.environment=${{ matrix.environment }} \
        -Dcucumber.filter.tags="not @KnownIssue" \
        -Dbrowser=chrome \
        -Dheadless=true \
        -Dsurefire.useFile=true \
        -Dmaven.test.failure.ignore=true \
        -Dtest.user.email=${TEST_USER_EMAIL} \
        -Dtest.user.password=${TEST_USER_PASSWORD}

    - name: Verify Test Results Directory
      if: always()
      run: |
        echo "Listing test results directory:"
        ls -la target/surefire-reports/ || true
        echo "Checking XML files:"
        find target/surefire-reports -name "*.xml" || true

    - name: Generate Allure Report
      if: always()
      run: mvn allure:report

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.environment }}-java${{ matrix.java }}
        path: |
          target/cucumber-reports/
          target/allure-results/
          target/surefire-reports/

    - name: Publish Test Results
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results (${{ matrix.environment }} - Java ${{ matrix.java }})
        path: target/surefire-reports/*.xml
        reporter: java-junit

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: always()
