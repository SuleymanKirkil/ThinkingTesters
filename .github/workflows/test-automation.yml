name: Test Automation Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Daily midnight run
  workflow_dispatch:  # Manual trigger

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11', '17' ]
        environment: [ 'staging', 'qa' ]
      fail-fast: false

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@v3
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
        cache: 'maven'

    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest

    - name: Setup Firefox
      uses: browser-actions/setup-firefox@latest

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run Tests
      run: |
        mvn clean test \
        -Dtest.environment=${{ matrix.environment }} \
        -Dcucumber.filter.tags="not @KnownIssue" \
        -Dbrowser=chrome \
        -Dheadless=true

    - name: Generate Allure Report
      if: always()
      run: mvn allure:report

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.environment }}-java${{ matrix.java }}
        path: |
          target/cucumber-reports/
          target/allure-results/
          target/surefire-reports/

    - name: Publish Test Report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results (${{ matrix.environment }} - Java ${{ matrix.java }})
        path: target/surefire-reports/*.xml
        reporter: java-junit

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: always()
